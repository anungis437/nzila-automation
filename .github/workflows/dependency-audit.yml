name: Dependency Audit

on:
  push:
    branches: [main, develop]
    paths:
      - '**/package.json'
      - 'pnpm-lock.yaml'
  pull_request:
    branches: [main]
    paths:
      - '**/package.json'
      - 'pnpm-lock.yaml'
  schedule:
    # Daily audit at 06:00 UTC
    - cron: '0 6 * * *'

jobs:
  audit:
    name: pnpm audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10.11.0

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Audit at critical level — exits non-zero immediately if criticals found.
      # No '|| true': this step gates the CI job.
      - name: Run pnpm audit (fail on critical)
        id: audit
        run: |
          # Write report to file; exit code propagates (non-zero = criticals found)
          pnpm audit --audit-level=critical --json > audit-report.json
          echo "Audit clean — no critical vulnerabilities found."

      # Also capture a high-severity JSON report for artifact upload (always runs)
      - name: Capture high-severity audit report
        if: always()
        run: |
          set +e; pnpm audit --audit-level=high --json > audit-report-high.json 2>/dev/null; set -e
          echo "High/critical audit report written to audit-report-high.json"

      - name: Enforce vulnerability waiver policy
        if: always()
        run: |
          REPORT=audit-report.json
          [ -f "$REPORT" ] || REPORT=audit-report-high.json
          pnpm tsx tooling/security/supply-chain-policy.ts check-vulns "$REPORT"

      - name: Upload audit reports as artifacts
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: dependency-audit-${{ github.run_id }}
          path: |
            audit-report.json
            audit-report-high.json
          retention-days: 90
