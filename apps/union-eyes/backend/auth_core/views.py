"""
DRF viewsets for auth_core app.
Auto-generated by Nzila Code Generator — 2026-02-17
"""
import hashlib
import hmac
import json
import logging
from typing import Dict, Any

from django.conf import settings
from django.contrib.auth import get_user_model
from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
from django.views.decorators.http import require_POST
from rest_framework import viewsets, permissions, filters
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from django_filters.rest_framework import DjangoFilterBackend
from .models import (InternationalAddresses, CountryAddressFormats, AddressValidationCache, AddressChangeHistory, FeatureFlags, OrganizationSharingSettings, CrossOrgAccessLog, OrganizationSharingGrants, UserUuidMapping, PendingProfiles, Profiles, Users, OrganizationUsers, UserSessions, OauthProviders, MemberContactPreferences, MemberEmploymentDetails, MemberConsents, MemberHistoryEvents, OrganizationMembers, SsoProviders, ScimConfigurations, SsoSessions, ScimEventsLog, MfaConfigurations, Organizations)
from .serializers import (InternationalAddressesSerializer, CountryAddressFormatsSerializer, AddressValidationCacheSerializer, AddressChangeHistorySerializer, FeatureFlagsSerializer, OrganizationSharingSettingsSerializer, CrossOrgAccessLogSerializer, OrganizationSharingGrantsSerializer, UserUuidMappingSerializer, PendingProfilesSerializer, ProfilesSerializer, UsersSerializer, OrganizationUsersSerializer, UserSessionsSerializer, OauthProvidersSerializer, MemberContactPreferencesSerializer, MemberEmploymentDetailsSerializer, MemberConsentsSerializer, MemberHistoryEventsSerializer, OrganizationMembersSerializer, SsoProvidersSerializer, ScimConfigurationsSerializer, SsoSessionsSerializer, ScimEventsLogSerializer, MfaConfigurationsSerializer)

logger = logging.getLogger(__name__)
User = get_user_model()


class InternationalAddressesViewSet(viewsets.ModelViewSet):
    """API endpoint for InternationalAddresses operations."""
    queryset = InternationalAddresses.objects.all()
    serializer_class = InternationalAddressesSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class CountryAddressFormatsViewSet(viewsets.ModelViewSet):
    """API endpoint for CountryAddressFormats operations."""
    queryset = CountryAddressFormats.objects.all()
    serializer_class = CountryAddressFormatsSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['postal_code_required', 'has_subdivisions', 'geocoding_supported', 'standardization_available']
    search_fields = ['country_code', 'country_name', 'iso3_code', 'locality_label', 'administrative_area_label']
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class AddressValidationCacheViewSet(viewsets.ModelViewSet):
    """API endpoint for AddressValidationCache operations."""
    queryset = AddressValidationCache.objects.all()
    serializer_class = AddressValidationCacheSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['is_valid']
    search_fields = ['input_hash', 'country_code', 'address_line1', 'locality', 'administrative_area']
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class AddressChangeHistoryViewSet(viewsets.ModelViewSet):
    """API endpoint for AddressChangeHistory operations."""
    queryset = AddressChangeHistory.objects.all()
    serializer_class = AddressChangeHistorySerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class FeatureFlagsViewSet(viewsets.ModelViewSet):
    """API endpoint for FeatureFlags operations."""
    queryset = FeatureFlags.objects.all()
    serializer_class = FeatureFlagsSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['enabled']
    search_fields = ['name', 'type', 'description']
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class OrganizationSharingSettingsViewSet(viewsets.ModelViewSet):
    """API endpoint for OrganizationSharingSettings operations."""
    queryset = OrganizationSharingSettings.objects.all()
    serializer_class = OrganizationSharingSettingsSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class CrossOrgAccessLogViewSet(viewsets.ModelViewSet):
    """API endpoint for CrossOrgAccessLog operations."""
    queryset = CrossOrgAccessLog.objects.all()
    serializer_class = CrossOrgAccessLogSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['user_id']
    search_fields = ['user_id']
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class OrganizationSharingGrantsViewSet(viewsets.ModelViewSet):
    """API endpoint for OrganizationSharingGrants operations."""
    queryset = OrganizationSharingGrants.objects.all()
    serializer_class = OrganizationSharingGrantsSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class UserUuidMappingViewSet(viewsets.ModelViewSet):
    """API endpoint for UserUuidMapping operations."""
    queryset = UserUuidMapping.objects.all()
    serializer_class = UserUuidMappingSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    search_fields = ['clerk_user_id']
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class PendingProfilesViewSet(viewsets.ModelViewSet):
    """API endpoint for PendingProfiles operations."""
    queryset = PendingProfiles.objects.all()
    serializer_class = PendingProfilesSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['claimed']
    search_fields = ['id', 'email', 'token', 'membership', 'payment_provider']
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class ProfilesViewSet(viewsets.ModelViewSet):
    """API endpoint for Profiles operations."""
    queryset = Profiles.objects.all()
    serializer_class = ProfilesSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['membership', 'payment_provider', 'whop_membership_id']
    search_fields = ['user_id', 'email', 'membership', 'payment_provider', 'stripe_customer_id']
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class UsersViewSet(viewsets.ModelViewSet):
    """API endpoint for Users operations."""
    queryset = Users.objects.all()
    serializer_class = UsersSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['user_id']
    search_fields = ['user_id']
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class OrganizationUsersViewSet(viewsets.ModelViewSet):
    """API endpoint for OrganizationUsers operations."""
    queryset = OrganizationUsers.objects.all()
    serializer_class = OrganizationUsersSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['organization_id']
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class UserSessionsViewSet(viewsets.ModelViewSet):
    """API endpoint for UserSessions operations."""
    queryset = UserSessions.objects.all()
    serializer_class = UserSessionsSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['user_id']
    search_fields = ['user_id']
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class OauthProvidersViewSet(viewsets.ModelViewSet):
    """API endpoint for OauthProviders operations."""
    queryset = OauthProviders.objects.all()
    serializer_class = OauthProvidersSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['user_id']
    search_fields = ['user_id']
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class MemberContactPreferencesViewSet(viewsets.ModelViewSet):
    """API endpoint for MemberContactPreferences operations."""
    queryset = MemberContactPreferences.objects.all()
    serializer_class = MemberContactPreferencesSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['email_opt_in', 'sms_opt_in', 'phone_opt_in', 'mail_opt_in', 'interpreter_required']
    search_fields = ['preferred_contact_method', 'preferred_language', 'alternative_email', 'alternative_phone', 'emergency_contact_name']
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class MemberEmploymentDetailsViewSet(viewsets.ModelViewSet):
    """API endpoint for MemberEmploymentDetails operations."""
    queryset = MemberEmploymentDetails.objects.all()
    serializer_class = MemberEmploymentDetailsSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['benefits_eligible', 'pension_plan_enrolled', 'is_probationary', 'steward', 'officer', 'committee_member']
    search_fields = ['classification', 'job_title', 'job_code', 'pay_grade', 'department']
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class MemberConsentsViewSet(viewsets.ModelViewSet):
    """API endpoint for MemberConsents operations."""
    queryset = MemberConsents.objects.all()
    serializer_class = MemberConsentsSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['granted', 'requires_renewal']
    search_fields = ['consent_type', 'consent_category', 'consent_version', 'consent_text', 'consent_method']
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class MemberHistoryEventsViewSet(viewsets.ModelViewSet):
    """API endpoint for MemberHistoryEvents operations."""
    queryset = MemberHistoryEvents.objects.all()
    serializer_class = MemberHistoryEventsSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['is_public', 'visible_to_member']
    search_fields = ['event_type', 'event_category', 'event_title', 'event_description', 'actor_id']
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class OrganizationMembersViewSet(viewsets.ModelViewSet):
    """API endpoint for OrganizationMembers operations."""
    queryset = OrganizationMembers.objects.all()
    serializer_class = OrganizationMembersSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['organization_id', 'is_primary', 'member_category', 'exempt_from_per_capita', 'exemption_approved_by']
    search_fields = ['user_id', 'role', 'status', 'membership_number', 'member_category']
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class SsoProvidersViewSet(viewsets.ModelViewSet):
    """API endpoint for SsoProviders operations."""
    queryset = SsoProviders.objects.all()
    serializer_class = SsoProvidersSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['organization_id']
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class ScimConfigurationsViewSet(viewsets.ModelViewSet):
    """API endpoint for ScimConfigurations operations."""
    queryset = ScimConfigurations.objects.all()
    serializer_class = ScimConfigurationsSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['organization_id']
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class SsoSessionsViewSet(viewsets.ModelViewSet):
    """API endpoint for SsoSessions operations."""
    queryset = SsoSessions.objects.all()
    serializer_class = SsoSessionsSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['provider_id']
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class ScimEventsLogViewSet(viewsets.ModelViewSet):
    """API endpoint for ScimEventsLog operations."""
    queryset = ScimEventsLog.objects.all()
    serializer_class = ScimEventsLogSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['config_id']
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


class MfaConfigurationsViewSet(viewsets.ModelViewSet):
    """API endpoint for MfaConfigurations operations."""
    queryset = MfaConfigurations.objects.all()
    serializer_class = MfaConfigurationsSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['organization_id']
    ordering_fields = ['created_at', 'updated_at']
    ordering = ['-created_at']


# =============================================================================
# Clerk Webhook Handlers
# =============================================================================

@csrf_exempt
@require_POST
def clerk_webhook(request):
    """Handle Clerk webhook events for user synchronization.
    
    Clerk sends webhooks for:
    - user.created
    - user.updated
    - user.deleted
    - organization.created
    - organization.updated
    - organizationMembership.created
    - organizationMembership.updated
    - organizationMembership.deleted
    
    Webhook verification: https://clerk.com/docs/webhooks/overview
    """
    try:
        # Verify webhook signature
        if not _verify_clerk_webhook(request):
            logger.warning("Invalid Clerk webhook signature")
            return JsonResponse({"error": "Invalid signature"}, status=401)
        
        # Parse webhook payload
        payload = json.loads(request.body)
        event_type = payload.get("type")
        data = payload.get("data", {})
        
        logger.info(f"Received Clerk webhook: {event_type}")
        
        # Route to appropriate handler
        if event_type == "user.created":
            _handle_user_created(data)
        elif event_type == "user.updated":
            _handle_user_updated(data)
        elif event_type == "user.deleted":
            _handle_user_deleted(data)
        elif event_type == "organization.created":
            _handle_organization_created(data)
        elif event_type == "organization.updated":
            _handle_organization_updated(data)
        elif event_type == "organizationMembership.created":
            _handle_membership_created(data)
        elif event_type == "organizationMembership.deleted":
            _handle_membership_deleted(data)
        else:
            logger.info(f"Unhandled webhook event: {event_type}")
        
        return JsonResponse({"status": "success"}, status=200)
        
    except Exception as e:
        logger.exception(f"Clerk webhook error: {e}")
        return JsonResponse({"error": str(e)}, status=500)


def _verify_clerk_webhook(request) -> bool:
    """Verify Clerk webhook signature using webhook secret.
    
    Args:
        request: Django HttpRequest
        
    Returns:
        bool: True if signature is valid
    """
    webhook_secret = getattr(settings, "CLERK_WEBHOOK_SECRET", "")
    if not webhook_secret:
        logger.error("CLERK_WEBHOOK_SECRET not configured")
        return False
    
    # Get signature from headers
    svix_id = request.META.get("HTTP_SVIX_ID", "")
    svix_timestamp = request.META.get("HTTP_SVIX_TIMESTAMP", "")
    svix_signature = request.META.get("HTTP_SVIX_SIGNATURE", "")
    
    if not all([svix_id, svix_timestamp, svix_signature]):
        return False
    
    # Construct signed payload
    signed_content = f"{svix_id}.{svix_timestamp}.{request.body.decode('utf-8')}"
    
    # Clerk/svix secrets are "whsec_<base64-encoded-bytes>".
    # Strip the prefix and base64-decode to get the raw signing key.
    import base64
    secret_bytes: bytes
    if webhook_secret.startswith("whsec_"):
        secret_bytes = base64.b64decode(webhook_secret[len("whsec_"):])
    else:
        # Fallback: treat as raw UTF-8 bytes (non-standard format)
        secret_bytes = webhook_secret.encode("utf-8")

    # Compute expected signature
    expected_signature = hmac.new(
        secret_bytes,
        signed_content.encode("utf-8"),
        hashlib.sha256,
    ).hexdigest()

    # svix sends multiple signatures separated by spaces ("v1,<hex> v1,<hex>")
    # Accept if any one of them matches.
    return any(
        hmac.compare_digest(f"v1,{expected_signature}", sig.strip())
        for sig in svix_signature.split(" ")
        if sig.strip()
    )


def _handle_user_created(data: Dict[str, Any]):
    """Handle user.created webhook event.
    
    Creates Django User when new user signs up via Clerk.
    """
    clerk_user_id = data.get("id")
    email = data.get("email_addresses", [{}])[0].get("email_address", "")
    first_name = data.get("first_name", "")
    last_name = data.get("last_name", "")
    
    user, created = User.objects.get_or_create(
        username=clerk_user_id,
        defaults={
            "email": email,
            "first_name": first_name,
            "last_name": last_name,
            "is_active": True,
        },
    )
    
    if created:
        logger.info(f"Created user {clerk_user_id} from Clerk webhook")
    else:
        logger.info(f"User {clerk_user_id} already exists")


def _handle_user_updated(data: Dict[str, Any]):
    """Handle user.updated webhook event.
    
    Syncs user metadata changes from Clerk to Django.
    """
    clerk_user_id = data.get("id")
    
    try:
        user = User.objects.get(username=clerk_user_id)
        
        email = data.get("email_addresses", [{}])[0].get("email_address", "")
        first_name = data.get("first_name", "")
        last_name = data.get("last_name", "")
        
        updated = False
        if user.email != email:
            user.email = email
            updated = True
        if user.first_name != first_name:
            user.first_name = first_name
            updated = True
        if user.last_name != last_name:
            user.last_name = last_name
            updated = True
        
        if updated:
            user.save(update_fields=["email", "first_name", "last_name"])
            logger.info(f"Updated user {clerk_user_id}")
        
    except User.DoesNotExist:
        logger.warning(f"User {clerk_user_id} not found for update")


def _handle_user_deleted(data: Dict[str, Any]):
    """Handle user.deleted webhook event.
    
    Soft-deletes user in Django (sets is_active=False).
    """
    clerk_user_id = data.get("id")
    
    try:
        user = User.objects.get(username=clerk_user_id)
        user.is_active = False
        user.save(update_fields=["is_active"])
        logger.info(f"Deactivated user {clerk_user_id}")
        
    except User.DoesNotExist:
        logger.warning(f"User {clerk_user_id} not found for deletion")


def _handle_organization_created(data: Dict[str, Any]):
    """Handle organization.created webhook event.

    Creates or updates the local Organizations record with the Clerk org ID.
    This populates clerk_organization_id so proxy requests can scope by org.
    """
    clerk_org_id = data.get("id")
    org_name = data.get("name", "")
    slug = data.get("slug") or org_name.lower().replace(" ", "-")
    image_url = data.get("image_url")
    metadata = data.get("public_metadata", {})

    if not clerk_org_id:
        logger.warning("organization.created event missing id")
        return

    org, created = Organizations.objects.update_or_create(
        clerk_organization_id=clerk_org_id,
        defaults={
            "name": org_name,
            "slug": slug,
            "display_name": org_name,
            "organization_type": metadata.get("organization_type", "union"),
            "status": "active",
        },
    )
    action = "Created" if created else "Updated"
    logger.info(f"{action} organization {clerk_org_id} — {org_name} (local id: {org.id})")


def _handle_organization_updated(data: Dict[str, Any]):
    """Handle organization.updated webhook event."""
    clerk_org_id = data.get("id")
    org_name = data.get("name", "")
    slug = data.get("slug") or org_name.lower().replace(" ", "-")

    if not clerk_org_id:
        return

    try:
        org = Organizations.objects.get(clerk_organization_id=clerk_org_id)
        org.name = org_name
        org.display_name = org_name
        org.slug = slug
        org.save(update_fields=["name", "display_name", "slug"])
        logger.info(f"Updated organization {clerk_org_id}")
    except Organizations.DoesNotExist:
        logger.warning(f"Organization {clerk_org_id} not found for update — creating")
        _handle_organization_created(data)


def _handle_membership_created(data: Dict[str, Any]):
    """Handle organizationMembership.created webhook event.

    Creates an OrganizationMembers record linking the Clerk user to the local org.
    """
    clerk_user_id = data.get("public_user_data", {}).get("user_id")
    clerk_org_id = data.get("organization", {}).get("id")
    role = data.get("role", "member")

    if not clerk_user_id or not clerk_org_id:
        logger.warning("organizationMembership.created missing user or org id")
        return

    try:
        org = Organizations.objects.get(clerk_organization_id=clerk_org_id)
    except Organizations.DoesNotExist:
        logger.warning(
            f"Cannot create membership — org {clerk_org_id} not found locally. "
            f"Run organization.created first."
        )
        return

    membership, created = OrganizationMembers.objects.update_or_create(
        user_id=clerk_user_id,
        organization=org,
        defaults={
            "role": role,
            "status": "active",
            "is_primary": True,
        },
    )
    action = "Created" if created else "Updated"
    logger.info(f"{action} membership: user {clerk_user_id} in org {clerk_org_id} as {role}")


def _handle_membership_deleted(data: Dict[str, Any]):
    """Handle organizationMembership.deleted webhook event.

    Sets the OrganizationMembers status to 'inactive' (soft-delete).
    """
    clerk_user_id = data.get("public_user_data", {}).get("user_id")
    clerk_org_id = data.get("organization", {}).get("id")

    if not clerk_user_id or not clerk_org_id:
        return

    try:
        org = Organizations.objects.get(clerk_organization_id=clerk_org_id)
        updated = OrganizationMembers.objects.filter(
            user_id=clerk_user_id, organization=org
        ).update(status="inactive")
        logger.info(f"Deactivated {updated} membership records for user {clerk_user_id} in org {clerk_org_id}")
    except Organizations.DoesNotExist:
        logger.warning(f"Org {clerk_org_id} not found for membership deletion")


@api_view(["GET"])
@permission_classes([IsAuthenticated])
def me(request):
    """Get current authenticated user's profile.
    
    Returns:
        {
            "id": "user_id",
            "email": "user@example.com",
            "first_name": "John",
            "last_name": "Doe",
            "clerk_user_id": "user_2...",
            "organization": {"id": "org_id", "role": "admin"}
        }
    """
    user = request.user
    
    return Response({
        "id": str(user.id) if hasattr(user, "id") else None,
        "email": user.email,
        "first_name": user.first_name,
        "last_name": user.last_name,
        "clerk_user_id": user.username,  # Username is Clerk user ID
        "organization": {
            "id": getattr(request, "clerk_org_id", None),
            "role": getattr(request, "clerk_org_role", None),
        },
    })


@api_view(["GET"])
def health_check(request):
    """Health check endpoint for load balancers."""
    return Response({"status": "healthy"})


@api_view(["GET"])
@permission_classes([IsAuthenticated])
def member_profile(request):
    """Enriched member profile endpoint.

    Returns the Clerk-based user profile combined with organization membership
    info and claims statistics from the local database.

    Response shape matches the legacy /api/members/me Next.js route so the
    frontend can be proxied here without code changes.
    """
    from django.db.models import Count, Q  # local import to avoid circular

    user = request.user
    clerk_user_id: str = user.username  # ClerkAuthentication sets username = Clerk user ID

    # ── Claims stats from grievances ──────────────────────────────────────────
    try:
        from grievances.models import Claims  # noqa: PLC0415
        qs = Claims.objects.filter(member_id=clerk_user_id)
        total = qs.count()
        active = qs.filter(
            ~Q(status__in=["resolved", "rejected", "closed"])
        ).count()
        resolved = qs.filter(status="resolved").count()
        rejected = qs.filter(status="rejected").count()
        recent_claims = list(
            qs.order_by("-created_at").values(
                "claim_id", "claim_number", "claim_type",
                "status", "priority", "created_at",
            )[:5]
        )
        # Serialize UUIDs / datetimes
        for c in recent_claims:
            if c.get("claim_id"):
                c["claim_id"] = str(c["claim_id"])
            if c.get("created_at"):
                c["created_at"] = c["created_at"].isoformat()
    except Exception:
        total = active = resolved = rejected = 0
        recent_claims = []

    # ── Org membership (for display name / membership number) ─────────────────
    membership_data = {}
    try:
        membership = OrganizationMembers.objects.filter(
            user_id=clerk_user_id, status="active"
        ).select_related("organization").first()
        if membership:
            membership_data = {
                "membershipNumber": membership.membership_number,
                "role": membership.role,
                "memberCategory": membership.member_category,
            }
    except Exception:
        pass

    return Response({
        "profile": {
            "userId": clerk_user_id,
            "email": user.email,
            "firstName": user.first_name,
            "lastName": user.last_name,
            "displayName": f"{user.first_name} {user.last_name}".strip() or user.username,
            "organization": {
                "id": getattr(request, "clerk_org_id", None),
                "role": getattr(request, "clerk_org_role", None),
            },
            **membership_data,
            "claimsStats": {
                "total": total,
                "active": active,
                "resolved": resolved,
                "rejected": rejected,
            },
            "recentClaims": recent_claims,
        }
    })
